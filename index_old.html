<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…ÙˆÙ‚Ø¹ ÙƒÙˆÙŠØ² - Ahmed</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <style>
    :root{--bg:#FFF5E6;--card:#FFFFFF;--accent:#FF9F1C;--accent2:#2EC4B6;--text:#333}
    html,body{height:100%;margin:0;font-family:Tahoma, Arial, "Segoe UI", sans-serif;background:var(--bg);color:var(--text);}
    .app{max-width:1000px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    header img{width:70px;height:70px;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,.12)}
    h1{margin:0;font-size:1.6rem}
    nav{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
    .btn-secondary{background:var(--accent2)}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-top:14px}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .tile{padding:12px;border-radius:10px;cursor:pointer;text-align:center;background:linear-gradient(180deg,#fff,#FFF9F1);box-shadow:0 6px 14px rgba(0,0,0,.06)}
    .big{font-size:1.1rem}
    .question-box{font-size:1.1rem;padding:12px;border-radius:10px;margin-bottom:12px}
    .answers{display:grid;gap:8px}
    .answer{padding:10px;border-radius:10px;border:2px solid transparent;cursor:pointer}
    .answer:hover{transform:translateY(-2px)}
    .correct{border-color:green;background:#E6FFF2}
    .wrong{border-color:red;background:#FFEFEF}
    footer{margin-top:18px;font-size:.9rem;color:#666}
    input[type=text],input[type=url],select{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
    .small{font-size:.9rem}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .rtl-center{text-align:center}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid #eee}
    .muted{color:#777;font-size:.9rem}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <img src="https://images.unsplash.com/photo-1531746790731-6c087fecd65a?auto=format&fit=crop&w=200&q=60" alt="logo">
      <div>
        <h1>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒÙˆÙŠØ² Ù„Ø£Ø­Ù…Ø¯</h1>
        <div class="muted">Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ â€” Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯</div>
      </div>
    </header>

    <nav>
      <button class="btn" data-route="#home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn btn-secondary" data-route="#upload">ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø© (Google Sheets)</button>
      <button class="btn" data-route="#subjects">Ø§Ù„Ù…ÙˆØ§Ø¯</button>
      <button class="btn" data-route="#report">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    </nav>

    <main id="view" class="card">
      <!-- views rendered by JS -->
    </main>

    <footer class="muted">Ù…Ù„Ø­ÙˆØ¸Ø©: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (localStorage).</footer>
  </div>

  <!-- libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // ====== Configuration & storage keys ======
    const STORAGE_KEYS = {QUESTIONS:'quizz_questions_v1', PROGRESS:'quizz_progress_v1', ATTEMPTS:'quizz_attempts_v1'};
    const QUESTIONS_PER_QUIZ = 10;

    // ====== Utility ======
    function $(sel, ctx=document) { return ctx.querySelector(sel); }
    function $all(sel, ctx=document) { return Array.from(ctx.querySelectorAll(sel)); }
    function saveJSON(key,obj){localStorage.setItem(key,JSON.stringify(obj));}
    function loadJSON(key,def){try{return JSON.parse(localStorage.getItem(key))||def}catch(e){return def}}
    function nowStr(){return new Date().toLocaleString('ar-EG');}

    // ====== CSV parsing & loading ======
    function normalizeRow(row){
      // Expect columns: Subject,Lesson,Question,Wrong1,Wrong2,Wrong3,Right,Explanation,Difficulty
      return {
        subject: (row.Subject||row.subject||row['Ø§Ù„Ù…Ø§Ø¯Ø©']||'').trim(),
        lesson: (row.Lesson||row.lesson||row['Ø§Ù„Ø¯Ø±Ø³']||'').trim(),
        question: (row.Question||row.question||row['Ø§Ù„Ø³Ø¤Ø§Ù„']||'').trim(),
        wrong1: (row.Wrong1||row.wrong1||row['Ø§ØºÙ„Ø§Ø·1']||'').trim(),
        wrong2: (row.Wrong2||row.wrong2||row['Ø§ØºÙ„Ø§Ø·2']||'').trim(),
        wrong3: (row.Wrong3||row.wrong3||row['Ø§ØºÙ„Ø§Ø·3']||'').trim(),
        right: (row.Right||row.right||row['Ø§Ù„ØµØ­ÙŠØ­']||'').trim(),
        explanation: (row.Explanation||row.explanation||row['Ø§Ù„Ø´Ø±Ø­']||'').trim(),
        difficulty: (row.Difficulty||row.difficulty||row['Ø§Ù„ØµØ¹ÙˆØ¨Ø©']||'Ù…ØªÙˆØ³Ø·').trim()
      };
    }

    function loadQuestionsFromCSVText(csvText){
      const parsed = Papa.parse(csvText, {header:true,skipEmptyLines:true});
      const rows = parsed.data.map(normalizeRow).filter(r=>r.question && r.right && r.subject && r.lesson);
      saveJSON(STORAGE_KEYS.QUESTIONS,rows);
      return rows;
    }

    // ====== Routing & Views ======
    function router(){
      const hash = location.hash || '#home';
      const view = hash.replace('#','');
      if(view==='home') renderHome();
      else if(view==='upload') renderUpload();
      else if(view==='subjects') renderSubjects();
      else if(view==='lessons') renderLessons();
      else if(view==='quiz') renderQuiz();
      else if(view==='report') renderReport();
      else renderHome();
    }

    window.addEventListener('hashchange', router);
    document.addEventListener('click', e=>{const b=e.target.closest('[data-route]'); if(b){location.hash=b.dataset.route;}});

    // ====== Home ======
    function renderHome(){
      const q = loadJSON(STORAGE_KEYS.QUESTIONS,[]);
      document.getElementById('view').innerHTML = `
        <h2 class="rtl-center">Ø£Ù‡Ù„Ø§ Ø¨Ø£Ø­Ù…Ø¯ ğŸ‘‹</h2>
        <p class="muted">Ø§Ø®ØªØ¨Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø¨Ø¸Ø¨Ø·! Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ø«Ù… Ø§Ù„Ø¯Ø±Ø³ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±. ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Google Sheets ÙÙŠ ØµÙØ­Ø© "ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø©".</p>
        <div class="card">
          <div class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:</div>
          <div class="big">${q.length} Ø³Ø¤Ø§Ù„</div>
        </div>
        <div class="card">
          <div class="controls">
            <button class="btn" data-route="#subjects">Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯</button>
            <button class="btn btn-secondary" data-route="#upload">ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø©</button>
            <button class="btn" data-route="#report">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
          </div>
        </div>
      `;
    }

    // ====== Upload (Google Sheets) ======
    function renderUpload(){
      document.getElementById('view').innerHTML = `
        <h2>ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Google Sheets</h2>
        <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø¬Ø¯ÙˆÙ„ Google ÙƒÙ…Ù„Ù CSV Ø«Ù… Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØµØ¯ÙŠØ± Ù‡Ù†Ø§. Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù€ spreadsheet ÙˆØ±Ù‚Ù… Ø§Ù„ÙˆØ±Ù‚Ø© (gid).</p>

        <div class="card">
          <label>Ø±Ø§Ø¨Ø· CSV Ù…ÙØµØ¯Ù‘ÙØ± Ù…Ù† Google Sheets (export?format=csv)</label>
          <input id="csvUrl" type="url" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=0">
          <div style="height:8px"></div>
          <label>Ø£Ùˆ: Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù€ Spreadsheet ÙÙ‚Ø·</label>
          <input id="sheetId" type="text" placeholder="Spreadsheet ID (Ø§Ù„Ù†Øµ Ø§Ù„Ø·ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·)">
          <div style="height:8px"></div>
          <label>gid (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø¹Ø§Ø¯Ø© 0)</label>
          <input id="sheetGid" type="text" placeholder="0">
          <div style="height:8px"></div>
          <div class="controls">
            <button class="btn" id="loadCsvBtn">ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø©</button>
            <button class="btn btn-secondary" id="sampleBtn">ØªØ­Ù…ÙŠÙ„ Ø¹ÙŠÙ†Ø© CSV</button>
          </div>
          <div id="uploadMsg" class="muted small" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <div class="small">Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</div>
          <pre>Subject,Lesson,Question,Wrong1,Wrong2,Wrong3,Right,Explanation,Difficulty</pre>
        </div>
      `;

      $('#loadCsvBtn').addEventListener('click',async ()=>{
        const csvUrl = $('#csvUrl').value.trim();
        const id = $('#sheetId').value.trim();
        const gid = $('#sheetGid').value.trim() || '0';
        const msg = $('#uploadMsg');
        msg.textContent = '';
        try{
          let url = csvUrl;
          if(!url && id){
            url = `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;
          }
          if(!url) { msg.textContent='Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· CSV Ø£Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„Ù€ spreadsheet.'; return; }
          msg.textContent = 'ØªØ­Ù…ÙŠÙ„...';
          const res = await fetch(url);
          if(!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: '+res.status);
          const text = await res.text();
          const rows = loadQuestionsFromCSVText(text);
          msg.textContent = `ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${rows.length} Ø³Ø¤Ø§Ù„ ØªÙ… Ø­ÙØ¸Ù‡Ù….`;
          setTimeout(()=>location.hash='#subjects',800);
        }catch(err){msg.textContent = 'Ø®Ø·Ø£: '+err.message}
      });

      $('#sampleBtn').addEventListener('click', ()=>{
        const sample = `Subject,Lesson,Question,Wrong1,Wrong2,Wrong3,Right,Explanation,Difficulty\nØ±ÙŠØ§Ø¶ÙŠØ§Øª,Ø§Ù„ÙƒØ³ÙˆØ±,Ù…Ø§ Ù†Ø§ØªØ¬ 1/2 + 1/4?,1/4,1/2,3/4,3/4,Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¨Ø³Ø·ÙŠÙ† Ø¨Ø¹Ø¯ ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù…Ù‚Ø§Ù…Ø§Øª,Ø³Ù‡Ù„`;
        const rows = loadQuestionsFromCSVText(sample);
        $('#uploadMsg').textContent = 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¹ÙŠÙ†Ø©.';
        setTimeout(()=>location.hash='#subjects',800);
      });
    }

    // ====== Subjects & Lessons ======
    function getSubjects(){
      const q = loadJSON(STORAGE_KEYS.QUESTIONS,[]);
      const map = {};
      q.forEach(r=>{ if(!map[r.subject]) map[r.subject] = new Set(); map[r.subject].add(r.lesson); });
      const subjects = Object.keys(map).map(s=>({subject:s, lessons: Array.from(map[s])}));
      return subjects;
    }

    function renderSubjects(){
      const subjects = getSubjects();
      document.getElementById('view').innerHTML = `
        <h2>Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
        <div class="list" id="subjectsList"></div>
      `;
      const list = $('#subjectsList');
      if(subjects.length===0){ list.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø­Ù…Ù„Ø© Ø¨Ø¹Ø¯. Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© "ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø¦Ù„Ø©".</div>'; return; }
      subjects.forEach(s=>{
        const t = document.createElement('div'); t.className='tile'; t.innerHTML = `<div class="big">${s.subject}</div><div class="muted small">${s.lessons.length} Ø¯Ø±Ø³</div>`;
        t.addEventListener('click',()=>{ location.hash = '#lessons'; sessionStorage.setItem('selectedSubject',s.subject); });
        list.appendChild(t);
      });
    }

    function renderLessons(){
      const subject = sessionStorage.getItem('selectedSubject');
      const q = loadJSON(STORAGE_KEYS.QUESTIONS,[]).filter(x=>x.subject===subject);
      const lessons = [...new Set(q.map(x=>x.lesson))];
      document.getElementById('view').innerHTML = `
        <h2>Ø§Ù„Ø¯Ø±ÙˆØ³ ÙÙŠ: ${subject}</h2>
        <div class="list" id="lessonsList"></div>
      `;
      const list = $('#lessonsList');
      lessons.forEach(lesson=>{
        const t = document.createElement('div'); t.className='tile'; t.innerHTML = `<div class="big">${lesson}</div><div class="muted small">${q.filter(r=>r.lesson===lesson).length} Ø³Ø¤Ø§Ù„</div>`;
        t.addEventListener('click',()=>{ sessionStorage.setItem('selectedLesson',lesson); location.hash='#quiz'; });
        list.appendChild(t);
      });
    }

    // ====== Quiz View & Logic ======
    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

    function startQuiz(subject,lesson){
      const all = loadJSON(STORAGE_KEYS.QUESTIONS,[]).filter(x=>x.subject===subject && x.lesson===lesson);
      const pool = shuffle([...all]).slice(0,QUESTIONS_PER_QUIZ);
      const state = {subject,lesson,questions:pool,idx:0,score:0,answers:[],startedAt:new Date().toISOString()};
      saveJSON(STORAGE_KEYS.PROGRESS,state);
      return state;
    }

    function renderQuiz(){
      let state = loadJSON(STORAGE_KEYS.PROGRESS,null);
      if(!state){
        const subject = sessionStorage.getItem('selectedSubject');
        const lesson = sessionStorage.getItem('selectedLesson');
        if(!subject||!lesson){ location.hash='#subjects'; return; }
        state = startQuiz(subject,lesson);
      }

      const cur = state.questions[state.idx];
      const qnum = state.idx+1;
      const answers = shuffle([cur.right, cur.wrong1, cur.wrong2, cur.wrong3].filter(Boolean));

      document.getElementById('view').innerHTML = `
        <h2>${state.subject} â€” ${state.lesson}</h2>
        <div class="muted small">Ø³Ø¤Ø§Ù„ ${qnum} Ù…Ù† ${state.questions.length}</div>
        <div class="question-box card">${cur.question}</div>
        <div class="answers" id="answers"></div>
        <div style="height:10px"></div>
        <div class="controls">
          <button class="btn" id="nextBtn" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button class="btn btn-secondary" id="quitBtn">Ø®Ø±ÙˆØ¬ ÙˆØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
        </div>
        <div id="explain" class="card hidden"></div>
      `;

      const answersDiv = $('#answers');
      answers.forEach(ans=>{
        const el = document.createElement('div'); el.className='answer card'; el.textContent = ans;
        el.addEventListener('click',()=>selectAnswer(el,ans,cur,state));
        answersDiv.appendChild(el);
      });

      $('#nextBtn').addEventListener('click', ()=>{
        // go next
        state = loadJSON(STORAGE_KEYS.PROGRESS);
        state.idx++;
        saveJSON(STORAGE_KEYS.PROGRESS,state);
        if(state.idx >= state.questions.length){ finishQuiz(state); }
        else renderQuiz();
      });

      $('#quitBtn').addEventListener('click', ()=>{ saveJSON(STORAGE_KEYS.PROGRESS,loadJSON(STORAGE_KEYS.PROGRESS)); location.hash='#subjects'; });
    }

    function selectAnswer(el,ans,cur,state){
      if(el.classList.contains('answered')) return;
      const correct = ans === cur.right;
      el.classList.add(correct ? 'correct' : 'wrong','answered');
      // disable other answers
      $all('.answer').forEach(a=>a.style.pointerEvents='none');
      // update state
      const prog = loadJSON(STORAGE_KEYS.PROGRESS);
      prog.answers.push({question:cur.question, selected:ans, correct:cur.right});
      if(correct) prog.score++;
      saveJSON(STORAGE_KEYS.PROGRESS,prog);
      // show explanation immediately
      const ex = $('#explain'); ex.classList.remove('hidden');
      ex.innerHTML = `<strong>Ø§Ù„Ø´Ø±Ø­:</strong><div style="margin-top:8px">${cur.explanation||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±Ø­.'}</div>`;
      $('#nextBtn').disabled = false;
    }

    function finishQuiz(state){
      const final = loadJSON(STORAGE_KEYS.PROGRESS);
      const total = final.questions.length;
      const score = final.score;
      // record attempt
      const attempts = loadJSON(STORAGE_KEYS.ATTEMPTS,[]);
      const wrongs = final.answers.filter(a=>a.selected !== a.correct).map(a=>({question:a.question,selected:a.selected,correct:a.correct}));
      attempts.unshift({date:nowStr(), subject:final.subject, lesson:final.lesson, score:score+'/'+total, wrongs, difficultySummary: summarizeDifficulty(final.questions)});
      saveJSON(STORAGE_KEYS.ATTEMPTS,attempts);
      // clear progress
      localStorage.removeItem(STORAGE_KEYS.PROGRESS);
      // show result
      document.getElementById('view').innerHTML = `
        <h2>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
        <div class="card">
          <div class="big">Ø¯Ø±Ø¬ØªÙƒ: ${score} Ù…Ù† ${total}</div>
          <div class="muted small">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${attempts[0].date}</div>
        </div>
        <div class="card">
          <h3>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</h3>
          <div id="wrongList"></div>
          <div style="height:8px"></div>
          <div class="controls">
            <button class="btn" data-route="#subjects">Ø§Ø®ØªØ¨Ø§Ø± Ø¢Ø®Ø±</button>
            <button class="btn btn-secondary" data-route="#report">Ø§Ø°Ù‡Ø¨ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
          </div>
        </div>
      `;
      const wl = $('#wrongList');
      if(wrongs.length===0) wl.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ â€” Ø¹Ù…Ù„ Ù…Ù…ØªØ§Ø²!</div>';
      else{
        wrongs.forEach(w=>{ const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div><strong>Ø§Ù„Ø³Ø¤Ø§Ù„:</strong> ${w.question}</div><div><strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${w.selected}</div><div><strong>Ø§Ù„ØµØ­ÙŠØ­:</strong> ${w.correct}</div>`; wl.appendChild(d); });
      }
    }

    function summarizeDifficulty(questions){
      const map = {Ø³Ù‡Ù„:0,Ù…ØªÙˆØ³Ø·:0,ØµØ¹Ø¨:0};
      questions.forEach(q=>{ const d = q.difficulty||'Ù…ØªÙˆØ³Ø·'; map[d] = (map[d]||0)+1; });
      return map;
    }

    // ====== Reports ======
    function renderReport(){
      const attempts = loadJSON(STORAGE_KEYS.ATTEMPTS,[]);
      document.getElementById('view').innerHTML = `
        <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</h2>
        <div class="card">
          <div class="controls">
            <button class="btn" id="exportCsv">ØªØµØ¯ÙŠØ± CSV</button>
            <button class="btn btn-secondary" id="clearAttempts">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
          </div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ø¯Ø±Ø³</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</th></tr></thead>
            <tbody id="attemptsBody"></tbody>
          </table>
        </div>
      `;
      const tbody = $('#attemptsBody');
      if(attempts.length===0) tbody.innerHTML = '<tr><td colspan="5" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¨Ø¹Ø¯.</td></tr>';
      else{
        attempts.forEach(a=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${a.date}</td><td>${a.subject}</td><td>${a.lesson}</td><td>${a.score}</td><td>${a.wrongs.length}</td>`;
          tr.addEventListener('click', ()=> showAttemptDetails(a));
          tbody.appendChild(tr);
        });
      }

      $('#exportCsv').addEventListener('click', ()=>{
        const rows = attempts.map(a=>({date:a.date,subject:a.subject,lesson:a.lesson,score:a.score,wrongs:JSON.stringify(a.wrongs)}));
        const csv = Papa.unparse(rows);
        const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='quizz_attempts.csv'; a.click(); URL.revokeObjectURL(url);
      });

      $('#clearAttempts').addEventListener('click', ()=>{ if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')){ localStorage.removeItem(STORAGE_KEYS.ATTEMPTS); renderReport(); }});
    }

    function showAttemptDetails(a){
      alert(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${a.date}\nØ§Ù„Ù…Ø§Ø¯Ø©: ${a.subject}\nØ§Ù„Ø¯Ø±Ø³: ${a.lesson}\nØ§Ù„Ø¯Ø±Ø¬Ø©: ${a.score}\nØ£Ø®Ø·Ø§Ø¡: ${a.wrongs.length}`);
    }

    // ====== Init ======
 

    router();
  </script>
</body>
</html>
