<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø£Ø­Ù…Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
<style>
 body { font-family: 'Tajawal', sans-serif; background:#f9f9c9; margin:0; padding:0; color:#003366; }
 header { background:#0055aa; color:#fff; padding:20px; text-align:center; font-size:26px; font-weight:bold; }
 #welcome { text-align:center; padding:15px; font-size:22px; color:#004a99; }
 .container { padding:20px; }
 .section-title { font-size:22px; margin-bottom:10px; font-weight:bold; }
 button { width:100%; padding:14px; margin:6px 0; border:none; border-radius:10px; font-size:18px; cursor:pointer; font-weight:bold; }
 .subject-btn { background:#ffdd55; color:#003366; }
 .lesson-btn { background:#cce0ff; color:#003366; }
 .quiz-new { background:#ffeb99 !important; }
 .quiz-attempted { background:#99ccff !important; }
 .quiz-perfect { background:#00cc88 !important; color:#fff !important; }
 #progressBar { width:100%; background:#ddd; height:14px; border-radius:8px; overflow:hidden; margin:10px 0; }
 #progressFill { height:100%; width:0%; background:#0077ff; transition:0.3s; }
 #rankBar { width:100%; background:#ccc; height:12px; border-radius:6px; margin-top:10px; }
 #rankFill { height:100%; width:0%; background:#ffaa00; transition:0.3s; }
 #quiz-box { background:#fff; padding:15px; border-radius:12px; box-shadow:0 0 10px #0002; }
 .answers button { background:#e6f0ff; margin:8px 0; }
 #reportTable { width:100%; border-collapse:collapse; margin-top:20px; }
 #reportTable td, #reportTable th { border:1px solid #999; padding:8px; text-align:center; }
 #reportTable th { background:#0055aa; color:white; }
</style>
</head>
<body>
<header>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø£Ø­Ù…Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</header>
<div id="welcome">Ù…Ø±Ø­Ø¨Ø§ ÙŠØ§ Ø£Ø­Ù…Ø¯ Ø±Ø§Ù…ÙŠ ðŸ‘‹</div>

<audio id="rankSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<div class="container">
 <div id="rankSection">
   <strong>Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span id="rankName">â€”</span>
   <div id="rankBar"><div id="rankFill"></div></div>
 </div>

 <h2 class="section-title">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
 <div id="subjects"></div>

 <h2 class="section-title">Ø§Ù„Ø¯Ø±ÙˆØ³</h2>
 <div id="lessons"></div>

 <h2 class="section-title">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
 <div id="quiz"></div>
 <div id="progressBar"><div id="progressFill"></div></div>
 
 <button onclick="showReport()" style="background:#0055aa;color:#fff;">ðŸ“˜ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
 <div id="report"></div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcWDsX4R4gqmGyWpFqA7WuzQvI-ajwYIJz12rvyj9fJyJ24FXkvdjlES87PvB0Umb4FpJCFCbCO1n_/pub?gid=0&single=true&output=csv";
let data = [];
let currentSubject = null;
let currentLesson = null;
let quizQuestions = [];
let currentIndex = 0;
let score = 0;

function fetchCSV() {
 fetch(CSV_URL)
   .then(r=>r.text())
   .then(t=>{
     data = t.split(/\r?\n/).map(r=>r.split(","));
     loadSubjects();
   })
   .catch(()=>alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"));
}

function loadSubjects(){
 const box = document.getElementById("subjects");
 box.innerHTML="";
 const subjects = [...new Set(data.slice(1).map(r=>r[0]))];
 subjects.forEach(sub=>{
   const btn = document.createElement("button");
   btn.className="subject-btn";
   btn.textContent=sub;
   btn.onclick=()=>loadLessons(sub);
   box.appendChild(btn);
 });
}

function loadLessons(subject){
 currentSubject = subject;
 const box = document.getElementById("lessons");
 box.innerHTML="";
 const lessons = [...new Set(data.filter(r=>r[0]==subject).map(r=>r[1]))];
 lessons.forEach(ls=>{
   const btn = document.createElement("button");
   btn.className = lessonColor(subject,ls);
   btn.textContent = ls + highestScoreLabel(subject,ls);
   btn.onclick = ()=>startQuiz(subject,ls);
   box.appendChild(btn);
 });
}

function lessonColor(sub,ls){
 const key = `attempt_${sub}_${ls}`;
 const attempts = JSON.parse(localStorage.getItem(key)||"[]");
 if(attempts.length===0) return "lesson-btn quiz-new";
 const best = Math.max(...attempts.map(a=>a.score));
 const total = data.filter(r=>r[0]==sub && r[1]==ls).length;
 if(best===total) return "lesson-btn quiz-perfect";
 return "lesson-btn quiz-attempted";
}

function highestScoreLabel(sub,ls){
 const key = `attempt_${sub}_${ls}`;
 const attempts = JSON.parse(localStorage.getItem(key)||"[]");
 if(attempts.length===0) return " (Ù„Ù… ØªÙØ­Ù„)";
 const best = Math.max(...attempts.map(a=>a.score));
 return ` (Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©: ${best})`;
}

function startQuiz(sub,ls){
 currentLesson = ls;
 const all = data.filter(r=>r[0]==sub && r[1]==ls);
 quizQuestions = shuffle(all).slice(0,10);
 currentIndex = 0;
 score = 0;
 updateProgress();
 renderQuestion();
}

function renderQuestion(){
 const q = quizQuestions[currentIndex];
 const box = document.getElementById("quiz");
 box.innerHTML = `
 <div id='quiz-box'>
  <h3>${q[2]}</h3>
  <div class='answers'></div>
 </div>`;
 const answers = shuffle([q[3],q[4],q[5],q[6]]);
 const ansBox = box.querySelector('.answers');
 answers.forEach(a=>{
   const b=document.createElement('button'); b.textContent=a;
   b.onclick=()=>check(a,q[6],q[7]);
   ansBox.appendChild(b);
 });
}

function check(selected,correct,explanation){
 if(selected===correct) score++;
 alert("Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©: " + correct + "\n" + explanation);
 currentIndex++;
 if(currentIndex<quizQuestions.length){ updateProgress(); renderQuestion(); }
 else finishQuiz();
}

function updateProgress(){
 const percent = (currentIndex / quizQuestions.length) * 100;
 document.getElementById("progressFill").style.width = percent + "%";
}

function finishQuiz(){
 const key = `attempt_${currentSubject}_${currentLesson}`;
 const attempts = JSON.parse(localStorage.getItem(key)||"[]");
 attempts.push({date: new Date().toLocaleString(), score});
 localStorage.setItem(key,JSON.stringify(attempts));
 updateRank();
 alert(`Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!\nØ¯Ø±Ø¬ØªÙƒ: ${score}`);
 loadLessons(currentSubject);
}

function showReport(){
 const box = document.getElementById("report");
 box.innerHTML = `<h2>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„</h2>`;
 const subjects = [...new Set(data.slice(1).map(r=>r[0]))];
 subjects.forEach(sub=>{
   box.innerHTML += `<h3>ðŸ“˜ ${sub}</h3>`;
   const lessons=[...new Set(data.filter(r=>r[0]==sub).map(r=>r[1]))];
   lessons.forEach(ls=>{
     const key = `attempt_${sub}_${ls}`;
     const attempts = JSON.parse(localStorage.getItem(key)||"[]");
     if(attempts.length===0){
       box.innerHTML += `<p>â€” ${ls}: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª</p>`;
     } else {
       let rows = attempts.map(a=>`<tr><td>${a.date}</td><td>${a.score}</td></tr>`).join("");
       box.innerHTML += `
       <h4>${ls}</h4>
       <table id='reportTable'>
         <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr>
         ${rows}
       </table>`;
     }
   });
 });
}

function shuffle(a){ return a.sort(()=>Math.random()-.5); }

function updateRank(){
 let totalAttempts = 0;
 for(let k in localStorage){ if(k.startsWith('attempt_')){
   totalAttempts += JSON.parse(localStorage.getItem(k)).length;
 }}
 const ranks=["Ù…Ø¬Ù†Ø¯","Ø¹Ø±ÙŠÙ","Ø±Ù‚ÙŠØ¨","Ù…Ø³Ø§Ø¹Ø¯","Ù…Ù„Ø§Ø²Ù…","Ù†Ù‚ÙŠØ¨","Ø±Ø§Ø¦Ø¯","Ø¹Ù‚ÙŠØ¯","Ø¹Ù…ÙŠØ¯","Ù„ÙˆØ§Ø¡","ÙØ±ÙŠÙ‚","Ù…Ø´ÙŠØ±"];
 let rankIndex = Math.floor(totalAttempts/10);
 if(rankIndex>=ranks.length) rankIndex=ranks.length-1;
 document.getElementById("rankName").textContent=ranks[rankIndex];
 document.getElementById("rankFill").style.width=((totalAttempts%10)*10)+"%";
 if(totalAttempts%10===0) document.getElementById("rankSound").play();
}

fetchCSV(); updateRank();
</script>
</body>
</html>
