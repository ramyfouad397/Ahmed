<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø£Ø­Ù…Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>
<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:"Cairo", sans-serif;}
body {background:#f8f8f8;}
.hidden {display:none;}
button {cursor:pointer; border:none; padding:14px 20px; border-radius:16px; font-size:18px; font-weight:700; transition:0.3s; width:100%; margin-bottom:14px;}

/* COLORS â€“ Playful Kids (Green/Yellow/Red) */
:root {
  --green:#38c172;
  --green-dark:#2f9e62;
  --yellow:#ffe45e;
  --yellow-dark:#f2d74b;
  --red:#ff6b6b;
  --red-dark:#e85b5b;
  --gray:#cccccc;
}

/* PAGES */
.page {padding:20px; min-height:100vh; animation:fade 0.5s;}
@keyframes fade {from {opacity:0;} to {opacity:1;}}

/* TITLES */
h1 {font-size:32px; margin-bottom:20px; color:#333;}
h2 {color:#333; margin:20px 0 10px;}

/* BUTTON STATES */
.btn-new {background:var(--yellow);} 
.btn-attempted {background:var(--green); color:white;} 
.btn-perfect {background:var(--red); color:white;} 
.btn-new:hover {background:var(--yellow-dark);} 
.btn-attempted:hover {background:var(--green-dark);} 
.btn-perfect:hover {background:var(--red-dark);} 

/* QUIZ CARD */
.quiz-box {background:white; padding:20px; border-radius:20px; box-shadow:0 4px 12px #0001; margin-bottom:30px;}
.answers button {background:#eee; border-radius:12px; padding:14px; margin:10px 0; font-size:18px;}
.answers button:hover {background:#ddd;}

/* PROGRESS BAR */
.progress {width:100%; height:14px; background:#ddd; border-radius:10px; overflow:hidden; margin:10px 0 20px;}
.progress-inner {height:100%; width:0%; background:var(--green); transition:0.4s;}

/* EXPLANATION */
.explanation {background:#fff8d6; padding:15px; margin-top:15px; border-radius:12px; font-size:16px; display:none;}
</style>
</head>
<body>

<!-- PAGE 1 â€“ HOME -->
<div id="page-home" class="page">
  <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ø£Ø­Ù…Ø¯ Ø±Ø§Ù…Ù‰ ğŸ‘‹</h1>
  <h2>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
  <div id="subjects"></div>
</div>

<!-- PAGE 2 â€“ SELECT QUIZ -->
<div id="page-quizzes" class="page hidden">
  <button onclick="goHome()" style="background:#bbb;">â¬… Ø±Ø¬ÙˆØ¹</button>
  <h1 id="subjectTitle"></h1>
  <h2>Ø§Ø®ØªØ± Ø§Ù„ÙƒÙˆÙŠØ²</h2>
  <div id="quizList"></div>
</div>

<!-- PAGE 3 â€“ QUIZ PAGE -->
<div id="page-quiz" class="page hidden">
  <button onclick="goQuizzes()" style="background:#bbb;">â¬… Ø±Ø¬ÙˆØ¹</button>
  <h1 id="quizTitle"></h1>

  <div class="progress"><div class="progress-inner" id="progressBar"></div></div>

  <div class="quiz-box">
    <h2 id="questionText"></h2>
    <div class="answers" id="answers"></div>
    <div class="explanation" id="explanationBox"></div>
    <button id="nextBtn" class="hidden" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>
</div>

<script>
let data = [];
let subjects = [];
let currentSubject = null;
let currentQuiz = null;
let questions = [];
let qIndex = 0;
let score = 0;
let attempts = JSON.parse(localStorage.getItem("attempts") || "{}");

/* FETCH DATA */
fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vRcWDsX4R4gqmGyWpFqA7WuzQvI-ajwYIJz12rvyj9fJyJ24FXkvdjlES87PvB0Umb4FpJCFCbCO1n_/pub?gid=0&single=true&output=csv")
  .then(r=>r.text())
  .then(csv=>{ parseCSV(csv); buildSubjects(); });

function parseCSV(csv){
  const lines = csv.split("\n").map(l=>l.split(","));
  data = lines.slice(1).map(r=>({
    subject:r[0], lesson:r[1], question:r[2], wrong:[r[3],r[4],r[5]], right:r[6], explanation:r[7]
  }));
}

function buildSubjects(){
  const container = document.getElementById("subjects");
  subjects = [...new Set(data.map(d=>d.subject))];
  container.innerHTML = subjects.map(s=>`<button class='btn-new' onclick='openSubject("${s}")'>${s}</button>`).join("");
}

function openSubject(sub){
  currentSubject = sub;
  showPage("page-quizzes");
  document.getElementById("subjectTitle").innerText = sub;

  const lessons = [...new Set(data.filter(d=>d.subject===sub).map(d=>d.lesson))];
  const container = document.getElementById("quizList");
  container.innerHTML = "";

  lessons.forEach(les=>{
    const key = `${sub}_${les}`;
    const best = attempts[key] || 0;
    let cls = "btn-new";
    if(best>0) cls="btn-attempted";
    if(best=== countQuestions(sub, les)) cls="btn-perfect";
    container.innerHTML += `<button class='${cls}' onclick='startQuiz("${les}")'>${les} â€” Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©: ${best}</button>`;
  });
}

function countQuestions(sub, les){ return data.filter(d=>d.subject===sub && d.lesson===les).length; }

/* QUIZ */
function startQuiz(les){
  currentQuiz = les;
  questions = data.filter(d=>d.subject===currentSubject && d.lesson===currentQuiz);
  qIndex = 0;
  score = 0;
  showPage("page-quiz");
  loadQuestion();
}

function loadQuestion(){
  const q = questions[qIndex];
  document.getElementById("quizTitle").innerText = `${currentSubject} â€” ${currentQuiz}`;
  document.getElementById("questionText").innerText = q.question;
  const exp = document.getElementById("explanationBox");
  exp.style.display="none";
  document.getElementById("nextBtn").classList.add("hidden");

  // progress
  document.getElementById("progressBar").style.width = ((qIndex)/questions.length*100)+"%";

  // shuffle answers
  const answers = [...q.wrong, q.right].sort(()=>Math.random()-0.5);
  document.getElementById("answers").innerHTML =
    answers.map(a=>`<button onclick='answer("${a.replace(/"/g,"&quot;")}")'>${a}</button>`).join("");
}

function answer(ans){
  const q = questions[qIndex];
  const exp = document.getElementById("explanationBox");
  exp.style.display="block";

  if(ans===q.right){
    exp.innerHTML = "âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!<br>" + q.explanation;
    score++;
  } else {
    exp.innerHTML = `âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!<br>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.right}<br>${q.explanation}`;
  }

  // disable answers
  document.querySelectorAll("#answers button").forEach(b=>b.disabled=true);
  document.getElementById("nextBtn").classList.remove("hidden");
}

function nextQuestion(){
  qIndex++;
  if(qIndex<questions.length) loadQuestion();
  else finishQuiz();
}

function finishQuiz(){
  document.getElementById("progressBar").style.width="100%";
  const key = `${currentSubject}_${currentQuiz}`;
  attempts[key] = Math.max(attempts[key]||0, score);
  localStorage.setItem("attempts", JSON.stringify(attempts));
  setTimeout(()=>{ openSubject(currentSubject); }, 500);
}

/* NAVIGATION */
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
function goHome(){ showPage('page-home'); }
function goQuizzes(){ openSubject(currentSubject); showPage('page-quizzes'); }
</script>
</body>
</html>
